- name: Create frontend dir
  file: path=/home/ec2-user/frontend state=directory mode=0755

- name: Copy frontend
  synchronize:
    src: ../../../website/frontend/
    dest: /home/ec2-user/frontend
    rsync_opts:
      - '--verbose'

- name: run install
  community.general.npm:
    path: /home/ec2-user/frontend
  environment:
    REACT_APP_GITHUB_CLIENT_ID: "{{ lookup('env','REACT_APP_GITHUB_CLIENT_ID') }}"
    REACT_APP_GITHUB_CALLBACK_URL: "{{ lookup('env','REACT_APP_GITHUB_CALLBACK_URL') }}"
    REACT_APP_TELEGRAM_BOT_NAME: "{{ lookup('env','REACT_APP_TELEGRAM_BOT_NAME') }}"
    REACT_APP_API_PATH: "{{ lookup('env','REACT_APP_API_PATH') }}"
    REACT_APP_WS_URI: "{{ lookup('env','REACT_APP_WS_URI') }}"
    REACT_APP_IDE_URI: "{{ lookup('env','REACT_APP_IDE_URI') }}"
    REACT_APP_API_CONNECT_ADDRESS: "{{ lookup('env','REACT_APP_API_CONNECT_ADDRESS') }}"
    REACT_APP_RRT: "{{ lookup('env','REACT_APP_RRT') }}"
    REACT_APP_WASM_COMPILER: "{{ lookup('env','REACT_APP_WASM_COMPILER') }}"

- name: Build
  shell: >
    cd /home/ec2-user/frontend; npm run build; cd ..

- name: Delete old frontend files
  file:
    state: absent
    path: /var/www/html/
  become: yes

- name: Copy frontend build files
  copy:
    src: /home/ec2-user/frontend/build/
    dest: /var/www/html/
    remote_src: true
    owner: nginx
    group: nginx
    mode: '0744'
  become: yes
# - name: Delete frontend sources
#   file:
#     state: absent
#     path: /home/ec2-user/frontend
